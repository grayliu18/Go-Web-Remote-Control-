<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- ç¦æ­¢ç¼©æ”¾ï¼Œå…¨å± -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
     <!-- æ·»åŠ åˆ°ä¸»å±å¹•åå…¨å± -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ç½‘é¡µé¥æ§å™¨</title>
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; font-family: sans-serif;
            background-color: #333; color: #eee;
            user-select: none; -webkit-user-select: none; /* ç¦æ­¢é€‰æ‹©æ–‡æœ¬ */
             -webkit-tap-highlight-color: transparent; /* ç¦æ­¢ç‚¹å‡»é«˜äº® */
        }
        * { box-sizing: border-box; }

        #container { display: flex; flex-direction: column; height: 100%; padding: 5px; gap: 5px;}
        #status { padding: 5px 10px; background-color: #444; font-size: 12px; text-align: center;}

        .keyboard-row { display: flex; gap: 5px; height: 40px; }
         #keyboardInput { flex-grow: 1; padding: 0 10px; border: 1px solid #555; background-color: #222; color: white; border-radius: 4px; font-size: 16px;}

        /* æ ¸å¿ƒè§¦æ‘¸æ¿ï¼štouch-action: none è‡³å…³é‡è¦ï¼Œé˜»æ­¢æµè§ˆå™¨é»˜è®¤è§¦æ‘¸è¡Œä¸ºï¼ˆæ»šåŠ¨/ç¼©æ”¾ï¼‰ */
         .touchpad {
            flex-grow: 1; /* å æ®å‰©ä½™ç©ºé—´ */
            background-color: #555; border: 1px dashed #888;
            display: flex; justify-content: center; align-items: center;
            touch-action: none;
            border-radius: 8px;
            font-size: 14px; color: #aaa;
            overflow: hidden;
         }
        .buttons-row { display: flex; width: 100%; height: 60px; gap: 5px;}
        .keys-row { display: flex; width: 100%; height: 45px; gap: 5px;}

        .btn {
            flex: 1; font-size: 16px; border: 1px solid #666; background-color: #4a4a4a;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; border-radius: 4px;
            touch-action: none; /* æŒ‰é’®ä¹Ÿé˜»æ­¢ */
         }
        .btn:active, .btn.active { background-color: #777; color: white; border-color: #999;}
        .btn-key { font-size: 14px; background-color: #3a3a3a;}
        .btn-drag.active {
            background-color: #007bff; /* æ›´æ¸…æ™°çš„è“è‰² */
            color: white;
            outline: 2px solid white; /* æ·»åŠ ç™½è‰²è½®å»“ */
            outline-offset: -2px; /* è½®å»“å‘å†… */
        }
        #leftClick, #rightClick { flex: 2;}
        #dragLock { flex: 1; background-color: #666;}

        .status-ok { color: #2ecc71;}
        .status-error { color: #e74c3c;}
        .status-connecting { color: #f1c40f;}

        /* --- æ–°å¢é”®ç›˜æ ·å¼ --- */
        .full-keyboard {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 5px 0; /* ä¸Šä¸‹ç•™ç©ºéš™ */
            border: 1px solid #666;
            border-radius: 4px;
            background-color: #383838;
            margin-bottom: 5px; /* å’Œä¸‹æ–¹å…ƒç´ ç•™ç©ºéš™ */
        }
        .full-keyboard {
            /* display: flex; */ /* Replaced by fixed positioning */
            /* flex-direction: column; */
            gap: 5px;
            padding: 5px 5px; /* Adjusted padding */
            /* border: 1px solid #666; */ /* Optional: remove border if shadow is added */
            border-radius: 4px 4px 0 0; /* Top corners rounded */
            background-color: #383838;
            /* margin-bottom: 5px; */ /* Removed */
            position: fixed; /* Added */
            bottom: 0;       /* Added */
            left: 0;         /* Added */
            right: 0;        /* Added */
            z-index: 1000;   /* Added */
            box-shadow: 0 -2px 5px rgba(0,0,0,0.2); /* Optional shadow */
            display: none; /* Initially hidden, controlled by JS adding/removing a class/style */
        }
        .full-keyboard.visible { /* New class to control visibility */
             display: flex;
             flex-direction: column;
        }
        /* Remove .hidden class style as visibility is handled by .visible */
        /* .full-keyboard.hidden {
            display: none;
        } */
        .keyboard-button-row {
            display: flex;
            gap: 5px;
            height: 40px; /* ä¸å…¶ä»–æŒ‰é”®è¡Œé«˜åº¦ä¸€è‡´ */
            padding: 0 5px; /* è¡Œå†…å·¦å³ç•™ç©ºéš™ */
        }
        .keyboard-button {
            flex: 1; /* å‡åˆ†å®½åº¦ */
            font-size: 14px;
            border: 1px solid #555;
            background-color: #404040;
            color: #eee;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-radius: 4px;
            touch-action: none;
        }
        /* .keyboard-button:active { */ /* Replaced by .active class for sticky keys */
        .keyboard-button.active { /* Style for active sticky keys */
            background-color: #666;
            border-color: #888;
        }
        /* ç‰¹æ®ŠæŒ‰é’®å®½åº¦è°ƒæ•´ (å¯é€‰) */
        .keyboard-button.key-shift { flex: 1.5; }
        .keyboard-button.key-space { flex: 5; }
        .keyboard-button.key-enter { flex: 1.5; }
        .full-keyboard .key-hide { /* Added rule for hide button */
            z-index: 1001; /* Ensure it's above other keyboard elements if needed */
            /* Optional: Add more styles for visibility if needed */
        }
        /* --- é”®ç›˜æ ·å¼ç»“æŸ --- */

        /* --- æ–°å¢å…³æœºæŒ‰é’®æ ·å¼ --- */
        #shutdownBtn {
            background-color: #c0392b; /* çº¢è‰²è­¦å‘Š */
            color: white;
            border-color: #a03020;
        }
         #shutdownBtn:active {
             background-color: #e74c3c;
         }
         /* --- å…³æœºæŒ‰é’®æ ·å¼ç»“æŸ --- */

        /* Layout Classes for Manual Toggling */
        /* Default styles are implicitly Portrait */

        /* Landscape Layout Styles */
        body.layout-landscape #container {
            flex-direction: row; /* Change main layout to horizontal */
            flex-wrap: wrap; /* Allow wrapping if needed */
            align-items: stretch; /* Stretch items vertically */
        }
        body.layout-landscape #status {
            /* Optional: Adjust status bar for row layout if needed */
            order: -1; /* Move status to the beginning or adjust as needed */
            width: 100%; /* Take full width in row layout */
            text-align: left;
            padding: 2px 5px;
            font-size: 10px;
            height: auto;
        }
        body.layout-landscape .keyboard-row,
        body.layout-landscape .keys-row {
            /* Adjust width/height for row layout */
            width: 100%; /* Take full width initially */
            height: auto; /* Adjust height */
            flex-direction: row; /* Ensure buttons inside are row */
        }
         body.layout-landscape .keys-row {
             height: 40px; /* Keep specific height for keys row */
         }
        body.layout-landscape #touchpad {
            flex-grow: 1; /* Let it grow */
            flex-basis: 0; /* Change basis to 0 for equal distribution with grow */
            min-width: 150px;
            height: auto; /* Allow height to adjust */
            min-height: 150px; /* Ensure minimum height */
            order: 0; /* Default order */
        }
        body.layout-landscape .buttons-area { /* Create a wrapper for buttons if needed or style individually */
             display: flex;
             flex-direction: column; /* Stack button rows vertically */
             flex-grow: 1; /* Let it grow */
             flex-basis: 0; /* Change basis to 0 for equal distribution with grow */
             gap: 5px;
             padding-left: 5px; /* Add gap from touchpad */
             order: 1; /* Place after touchpad */
        }
        body.layout-landscape .buttons-row {
             width: 100%; /* Full width within their container */
             height: 50px; /* Slightly shorter button row */
        }
        /* Ensure full keyboard still behaves correctly (fixed position) */
        /* No changes needed for fullKeyboard usually, as it's fixed */

        /* --- æ–°å¢æ»‘å—æ ·å¼ --- */
        .slider-row {
            /* display: flex; align-items: center; gap: 10px; padding: 5px 0; height: 35px; */ /* Inline styles already set */
            margin-bottom: 5px; /* Add some space below */
        }
        #sensitivitySlider {
            /* Basic appearance reset */
            -webkit-appearance: none;
            appearance: none;
            width: 100%; /* Full width within its flex container */
            /* height: 10px; */ /* Already set inline */
            background: #444; /* Track color */
            outline: none;
            border-radius: 5px;
            /* cursor: pointer; */ /* Already set inline */
        }
        /* Thumb styling for Webkit browsers (Chrome, Safari) */
        #sensitivitySlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #777; /* Thumb color */
            border-radius: 50%;
            cursor: pointer;
            border: 1px solid #999;
        }
        /* Thumb styling for Firefox */
        #sensitivitySlider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #777;
            border-radius: 50%;
            cursor: pointer;
            border: 1px solid #999;
        }
        /* --- æ»‘å—æ ·å¼ç»“æŸ --- */

    </style>
</head>
<body>
 <div id="container">
    <div id="status" class="status-error">æœªè¿æ¥</div>

    <div class="keyboard-row">
         <input type="text" id="keyboardInput" placeholder="åœ¨æ­¤è¾“å…¥æ–‡æœ¬...">
         <div id="sendTextBtn" class="btn btn-key" style="flex: 0 0 60px;">å‘é€</div>
    </div>
     <div class="keys-row">
         <div class="btn btn-key" data-key="escape">ESC</div>
         <div class="btn btn-key" data-key="tab">TAB</div>
         <div class="btn btn-key" data-key="backspace">âŒ« BSP</div>
          <div class="btn btn-key" data-key="enter">â Enter</div>
          <div class="btn btn-key" data-key="up">â†‘</div>
          <div class="btn btn-key" data-key="down">â†“</div>
          <div class="btn btn-key" data-key="left">â†</div>
          <div class="btn btn-key" data-key="right">â†’</div>
          <div class="btn btn-key" data-key="delete">DEL</div> <!-- Added Delete Button -->
     </div>

     <!-- åˆ‡æ¢é”®ç›˜æŒ‰é’®å·²ç§»åŠ¨åˆ°ä¸‹æ–¹ -->

     <!-- æ–°å¢ï¼šå®Œæ•´é”®ç›˜åŒºåŸŸ (é»˜è®¤éšè—) -->
     <div id="fullKeyboard" class="full-keyboard hidden">
         <div class="keyboard-button-row" style="height: 35px;"> <!-- Slightly shorter row for F-keys -->
             <div class="keyboard-button" data-key="f1" style="font-size: 12px;">F1</div>
             <div class="keyboard-button" data-key="f2" style="font-size: 12px;">F2</div>
             <div class="keyboard-button" data-key="f3" style="font-size: 12px;">F3</div>
             <div class="keyboard-button" data-key="f4" style="font-size: 12px;">F4</div>
             <div class="keyboard-button" data-key="f5" style="font-size: 12px;">F5</div>
             <div class="keyboard-button" data-key="f6" style="font-size: 12px;">F6</div>
             <div class="keyboard-button" data-key="f7" style="font-size: 12px;">F7</div>
             <div class="keyboard-button" data-key="f8" style="font-size: 12px;">F8</div>
             <div class="keyboard-button" data-key="f9" style="font-size: 12px;">F9</div>
             <div class="keyboard-button" data-key="f10" style="font-size: 12px;">F10</div>
             <div class="keyboard-button" data-key="f11" style="font-size: 12px;">F11</div>
             <div class="keyboard-button" data-key="f12" style="font-size: 12px;">F12</div>
         </div>
         <div class="keyboard-button-row">
             <div class="keyboard-button" data-key="`">`</div>
             <div class="keyboard-button" data-key="1">1</div>
             <div class="keyboard-button" data-key="2">2</div>
             <div class="keyboard-button" data-key="3">3</div>
             <div class="keyboard-button" data-key="4">4</div>
             <div class="keyboard-button" data-key="5">5</div>
             <div class="keyboard-button" data-key="6">6</div>
             <div class="keyboard-button" data-key="7">7</div>
             <div class="keyboard-button" data-key="8">8</div>
             <div class="keyboard-button" data-key="9">9</div>
             <div class="keyboard-button" data-key="0">0</div>
             <div class="keyboard-button" data-key="-">-</div>
             <div class="keyboard-button" data-key="=">=</div>
             <div class="keyboard-button key-backspace" data-key="backspace">âŒ«</div>
         </div>
         <div class="keyboard-button-row">
             <div class="keyboard-button key-tab" data-key="tab">Tab</div>
             <div class="keyboard-button" data-key="q">q</div>
             <div class="keyboard-button" data-key="w">w</div>
             <div class="keyboard-button" data-key="e">e</div>
             <div class="keyboard-button" data-key="r">r</div>
             <div class="keyboard-button" data-key="t">t</div>
             <div class="keyboard-button" data-key="y">y</div>
             <div class="keyboard-button" data-key="u">u</div>
             <div class="keyboard-button" data-key="i">i</div>
             <div class="keyboard-button" data-key="o">o</div>
             <div class="keyboard-button" data-key="p">p</div>
             <div class="keyboard-button" data-key="[">[</div>
             <div class="keyboard-button" data-key="]">]</div>
             <div class="keyboard-button" data-key="\">\\</div>
         </div>
         <div class="keyboard-button-row">
             <!-- Caps Lock å ä½ç¬¦ï¼Œæš‚ä¸å®ç°åŠŸèƒ½ -->
             <div class="keyboard-button" data-key="capslock" style="flex: 1.3;">Caps</div>
             <div class="keyboard-button" data-key="a">a</div>
             <div class="keyboard-button" data-key="s">s</div>
             <div class="keyboard-button" data-key="d">d</div>
             <div class="keyboard-button" data-key="f">f</div>
             <div class="keyboard-button" data-key="g">g</div>
             <div class="keyboard-button" data-key="h">h</div>
             <div class="keyboard-button" data-key="j">j</div>
             <div class="keyboard-button" data-key="k">k</div>
             <div class="keyboard-button" data-key="l">l</div>
             <div class="keyboard-button" data-key=";">;</div>
             <div class="keyboard-button" data-key="'">'</div>
             <div class="keyboard-button key-enter" data-key="enter">Enter</div>
         </div>
         <div class="keyboard-button-row">
             <div class="keyboard-button key-shift" data-key="shift">Shift</div>
             <div class="keyboard-button" data-key="z">z</div>
             <div class="keyboard-button" data-key="x">x</div>
             <div class="keyboard-button" data-key="c">c</div>
             <div class="keyboard-button" data-key="v">v</div>
             <div class="keyboard-button" data-key="b">b</div>
             <div class="keyboard-button" data-key="n">n</div>
             <div class="keyboard-button" data-key="m">m</div>
             <div class="keyboard-button" data-key=",">,</div>
             <div class="keyboard-button" data-key=".">.</div>
             <div class="keyboard-button" data-key="/">/</div>
             <div class="keyboard-button key-shift" data-key="shift">Shift</div>
         </div>
         <div class="keyboard-button-row">
             <div class="keyboard-button" data-key="ctrl" style="flex: 1.2;">Ctrl</div>
             <div class="keyboard-button" data-key="alt" style="flex: 1.2;">Alt</div>
             <div class="keyboard-button" data-key="win" style="flex: 1.2;">Win</div> <!-- Added Win Key -->
             <div class="keyboard-button key-space" data-key="space">Space</div>
             <div class="keyboard-button" data-key="alt" style="flex: 1.2;">Alt</div>
             <div class="keyboard-button" data-key="ctrl" style="flex: 1.2;">Ctrl</div>
             <div class="keyboard-button key-hide" style="flex: 1.5; background-color: #5a5a5a;"></div> <!-- Removed text "éšè—" -->
         </div>
     </div>

    <div id="touchpad" class="touchpad">è§¦æ‘¸ & æ»šåŠ¨åŒº (å•å‡» / åŒæŒ‡æ»šåŠ¨)</div>

    <div class="buttons-area"> <!-- Added wrapper div -->
        <div class="slider-row" style="display: flex; align-items: center; gap: 10px; padding: 5px 0; height: 35px;">
            <label for="sensitivitySlider" style="font-size: 14px; flex-shrink: 0; color: #ccc;">é€Ÿåº¦:</label>
            <input type="range" id="sensitivitySlider" min="0.5" max="20" step="0.1" value="1.5" style="flex-grow: 1; height: 10px; cursor: pointer;">
            <input type="number" id="sensitivityInput" min="0.5" max="20" step="0.1" value="1.5" style="width: 60px; background-color: #222; color: #eee; border: 1px solid #555; border-radius: 4px; text-align: center; font-size: 14px; padding: 2px; margin: 0 5px;">
            <span id="sensitivityValue" style="font-size: 14px; min-width: 35px; text-align: right; color: #ccc;">1.5x</span>
        </div>

        <div class="buttons-row">
            <div id="leftClick" class="btn">å·¦é”®</div>
            <div id="dragLock" class="btn btn-drag">å·¦é”®æŒ‰ä½</div>
            <div id="rightClick" class="btn">å³é”®</div>
            <!-- æ–°å¢ï¼šå…³æœºæŒ‰é’® -->
            <div id="shutdownBtn" class="btn" style="flex: 1.5;">å…³æœº</div>
        </div>
        <!-- ç§»åŠ¨åˆ°æ­¤ï¼šåˆ‡æ¢é”®ç›˜æŒ‰é’® -->
        <div class="keys-row" style="height: 35px; margin-top: 5px;"> <!-- æ·»åŠ ä¸€ç‚¹ä¸Šè¾¹è· -->
            <div id="toggleKeyboardBtn" class="btn btn-key" style="flex: 1; background-color: #555;">âŒ¨ï¸ é”®ç›˜</div>
            <div id="toggleLayoutBtn" class="btn btn-key" style="flex: 1; background-color: #555;">ğŸ”„ å¸ƒå±€</div>
            <!-- Removed Trail Toggle Button -->
        </div>
    </div> <!-- Closing wrapper div -->
 </div>

    <script>
        const touchpad = document.getElementById('touchpad');
        const leftClickBtn = document.getElementById('leftClick');
        const rightClickBtn = document.getElementById('rightClick');
        const dragLockBtn = document.getElementById('dragLock');
        const statusDiv = document.getElementById('status');
        const keyboardInput = document.getElementById('keyboardInput');
        const sendTextBtn = document.getElementById('sendTextBtn');
        // const keyButtons = document.querySelectorAll('.btn-key[data-key]'); // æ—§çš„é€‰æ‹©å™¨ï¼Œä¸å†éœ€è¦
        // --- æ–°å¢å…ƒç´ å¼•ç”¨ ---
        const toggleKeyboardBtn = document.getElementById('toggleKeyboardBtn');
        const fullKeyboard = document.getElementById('fullKeyboard');
        // const fullKeyboardButtons = fullKeyboard.querySelectorAll('.keyboard-button[data-key]'); // æ—§çš„é€‰æ‹©å™¨ï¼Œä¸å†éœ€è¦
        // const hideKeyboardButton = fullKeyboard.querySelector('.key-hide'); // æ—§çš„é€‰æ‹©å™¨ï¼Œä¸å†éœ€è¦
        const toggleLayoutBtn = document.getElementById('toggleLayoutBtn'); // Added reference for layout toggle button
        const shutdownBtn = document.getElementById('shutdownBtn');
        // --- æ–°å¢å…ƒç´ å¼•ç”¨ç»“æŸ ---
        const sensitivitySlider = document.getElementById('sensitivitySlider');
        const sensitivityValue = document.getElementById('sensitivityValue');
        const sensitivityInput = document.getElementById('sensitivityInput');
        // Removed toggleTrailBtn reference

        // let mouseSensitivity = parseFloat(sensitivitySlider.value); // Initialize sensitivity - Replaced by localStorage logic below

        const sensitivityStorageKey = 'mouseSensitivitySetting';
        let initialSensitivity = 1.5; // Default value
        const storedSensitivity = localStorage.getItem(sensitivityStorageKey);
        if (storedSensitivity !== null) {
            const parsedValue = parseFloat(storedSensitivity);
            // Validate the stored value (0.5 to 20.0)
            if (!isNaN(parsedValue) && parsedValue >= 0.5 && parsedValue <= 20.0) {
                initialSensitivity = parsedValue;
            } else {
                console.warn("Invalid stored sensitivity value, using default.");
                localStorage.removeItem(sensitivityStorageKey); // Remove invalid value
            }
        }
        let mouseSensitivity = initialSensitivity; // Initialize global variable

        // --- æ–°å¢ï¼šç»Ÿä¸€æ›´æ–°çµæ•åº¦å‡½æ•° ---
        function updateSensitivity(newValue) {
            let numValue = parseFloat(newValue);
            // å¦‚æœè§£æå¤±è´¥æˆ–ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨å½“å‰çš„ mouseSensitivity å€¼ (é¿å…é‡ç½®ä¸ºé»˜è®¤å€¼)
            if (isNaN(numValue) || newValue === '') {
                numValue = mouseSensitivity;
            }

            // é™åˆ¶å€¼åœ¨ 0.5 åˆ° 20.0 ä¹‹é—´
            numValue = Math.max(0.5, Math.min(20.0, numValue));

            // æ›´æ–°å…¨å±€å˜é‡å’Œæ‰€æœ‰ç›¸å…³å…ƒç´ 
            mouseSensitivity = numValue;
            const formattedValue = numValue.toFixed(1); // æ ¼å¼åŒ–ä¸ºä¸€ä½å°æ•°
            sensitivitySlider.value = formattedValue;
            sensitivityInput.value = formattedValue;
            sensitivityValue.textContent = formattedValue + 'x';
            // console.log("Sensitivity updated to:", mouseSensitivity); // Optional debug
            localStorage.setItem(sensitivityStorageKey, mouseSensitivity.toFixed(1)); // Save to localStorage
        }
        // --- ç»“æŸï¼šç»Ÿä¸€æ›´æ–°çµæ•åº¦å‡½æ•° ---

        // Update sensitivity when slider changes
        sensitivitySlider.addEventListener('input', () => {
            updateSensitivity(sensitivitySlider.value); // è°ƒç”¨æ–°å‡½æ•°
        });

        // Update sensitivity when number input changes (use 'change' event)
        sensitivityInput.addEventListener('change', () => {
            updateSensitivity(sensitivityInput.value); // è°ƒç”¨æ–°å‡½æ•°
        });

        let ws;
        let reconnectInterval = 2000; // é‡è¿é—´éš” ms
        let isConnected = false;
        let reconnectTimer = null;

        // --- WebSocket è¿æ¥ä¸é‡è¿ ---
         function connect() {
            if (isConnected) return;
            clearTimeout(reconnectTimer);
            const wsUrl = `ws://${window.location.host}/ws`;
            console.log(`å°è¯•è¿æ¥åˆ° ${wsUrl}...`);
            setStatus(`æ­£åœ¨è¿æ¥ ${wsUrl}...`, 'connecting');

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                setStatus('âœ… å·²è¿æ¥', 'ok');
                isConnected = true;
                 dragLockActive = false; //é‡è¿åé‡ç½®æ‹–æ‹½çŠ¶æ€
                 dragLockBtn.classList.remove('active');
                 clearTimeout(reconnectTimer);
            };

            ws.onclose = (event) => {
                 if(isConnected) console.log('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥', event.code, event.reason);
                 isConnected = false;
                 setStatus(`âŒ å·²æ–­å¼€ï¼Œ${reconnectInterval/1000}ç§’åé‡è¯•...`, 'error');
                 // å°è¯•é‡è¿
                 reconnectTimer = setTimeout(connect, reconnectInterval);
            };

            ws.onerror = (error) => {
                console.error('WebSocket é”™è¯¯: ', error);
                 isConnected = false;
                 setStatus('âš ï¸ è¿æ¥é”™è¯¯', 'error');
                 ws.close(); // ç¡®ä¿è§¦å‘ onclose è¿›è¡Œé‡è¿
            };

            // --- æ–°å¢ï¼šå¤„ç†æ¥è‡ªæœåŠ¡å™¨çš„æ¶ˆæ¯ ---
            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    console.log("æ”¶åˆ°æ¶ˆæ¯:", message); // Log received message

                    // å¤„ç†çŠ¶æ€æ›´æ–°æ¶ˆæ¯
                    if (message.type === 'state_update' && message.state && typeof message.state.pointerTrailEnabled === 'boolean') {
                        const isEnabled = message.state.pointerTrailEnabled;
                        if (toggleTrailBtn) { // Check if button exists
                            toggleTrailBtn.textContent = isEnabled ? 'ğŸ–±ï¸ å…³é—­è½¨è¿¹' : 'ğŸ–±ï¸ å¼€å¯è½¨è¿¹';
                            console.log(`é¼ æ ‡è½¨è¿¹æŒ‰é’®æ›´æ–°ä¸º: ${toggleTrailBtn.textContent}`);
                        } else {
                            console.warn("æ‰¾ä¸åˆ° toggleTrailBtn å…ƒç´ æ¥æ›´æ–°æ–‡æœ¬ã€‚");
                        }
                    }
                    // åœ¨æ­¤æ·»åŠ å…¶ä»–æ¶ˆæ¯ç±»å‹çš„å¤„ç†é€»è¾‘ (å¦‚æœéœ€è¦)
                    // Removed pointer trail state update handling
                } catch (e) {
                    console.error("å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™:", e, "åŸå§‹æ•°æ®:", event.data);
                }
            };
            // --- æ¶ˆæ¯å¤„ç†ç»“æŸ ---
        } // connect å‡½æ•°çš„ç»“æŸæ‹¬å·

        function setStatus(text, type) {
             statusDiv.textContent = text;
             statusDiv.className = 'status-' + type;
        }

        // å°è£…å‘é€æŒ‡ä»¤çš„å‡½æ•°
        function sendCommand(command) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                 try {
                   // åœ¨å‘é€å‰æ‰“å°æŒ‡ä»¤ï¼Œç”¨äºè°ƒè¯•
                   // console.log("Sending command:", JSON.stringify(command));
                   ws.send(JSON.stringify(command));
                 } catch(e) {
                    console.error("Send command error:", e);
                 }
            }
        }

        // --- äº‹ä»¶çŠ¶æ€ç®¡ç† ---
        let lastX, lastY;
        let startX, startY; // ç”¨äºåˆ¤æ–­æ˜¯å¦æ˜¯ç‚¹å‡»
        let touchIdentifier = null; // è·Ÿè¸ªä¸»è§¦æ‘¸ç‚¹
        let isMoving = false;

        let scrollLastY = null;
        const SCROLL_SENSITIVITY = 1.5; // æ»šåŠ¨çµæ•åº¦
        const MOVE_THRESHOLD = 8; // ç§»åŠ¨è¶…è¿‡æ­¤åƒç´ æ‰è®¤ä¸ºæ˜¯åœ¨ç§»åŠ¨ï¼Œå¦åˆ™å¯èƒ½æ˜¯ç‚¹å‡»
        const DOUBLE_TAP_THRESHOLD = 350; // ms
        let lastTapTime = 0;

        let dragLockActive = false; // æ‹–æ‹½é”å®šçŠ¶æ€
        let isDraggingViaTouch = false; // æ ‡è®°å½“å‰è§¦æ‘¸æ˜¯å¦è§¦å‘äº†æ‹–æ‹½
        let isCapsLockActive = false; // æ–°å¢ï¼šè·Ÿè¸ª Caps Lock çŠ¶æ€
        let isCtrlActive = false; // æ–°å¢ï¼šè·Ÿè¸ª Ctrl çŠ¶æ€
        let isAltActive = false;  // æ–°å¢ï¼šè·Ÿè¸ª Alt çŠ¶æ€
        let isShiftActive = false; // æ–°å¢ï¼šè·Ÿè¸ª Shift çŠ¶æ€

        // --- äº‹ä»¶ç›‘å¬ ---

        // é˜»æ­¢è§¦æ‘¸æ¿é•¿æŒ‰å‡ºç°èœå•
        touchpad.addEventListener('contextmenu', (e) => e.preventDefault());

        touchpad.addEventListener('touchstart', (e) => {
            e.preventDefault();

            // Add logic to hide keyboard if visible when touchpad interaction starts
            if (fullKeyboard.classList.contains('visible')) {
                fullKeyboard.classList.remove('visible');
                // Optionally, return here if hiding the keyboard should prevent other touch actions immediately?
                // For now, let the touch handling proceed after hiding.
            }

            if (e.touches.length === 1) {
                 const touch = e.touches[0];
                 touchIdentifier = touch.identifier;
                 startX = lastX = touch.clientX;
                 startY = lastY = touch.clientY;
                 isMoving = false;
                 scrollLastY = null; // é‡ç½®æ»šåŠ¨
                 // å¦‚æœæ‹–æ‹½é”å®šæ¿€æ´»ï¼Œåˆ™åœ¨è§¦æ‘¸å¼€å§‹æ—¶æŒ‰ä¸‹é¼ æ ‡
                 if(dragLockActive) {
                    sendCommand({ type: 'mouse_down', button: 'left' });
                    isDraggingViaTouch = true;
                 }

            } else if (e.touches.length === 2) {
                 // åˆ‡æ¢åˆ°åŒæŒ‡æ»šåŠ¨æ¨¡å¼
                 touchIdentifier = null;
                 isMoving = false;
                 // è®¡ç®—ä¸¤æŒ‡ä¸­å¿ƒç‚¹ä½œä¸ºæ»šåŠ¨åŸºå‡†
                 scrollLastY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                  if(isDraggingViaTouch) { // å¦‚æœåœ¨æ‹–æ‹½ä¸­åŠ å…¥ç¬¬äºŒæŒ‡ï¼Œåˆ™åœæ­¢æ‹–æ‹½
                     sendCommand({ type: 'mouse_up', button: 'left' });
                     isDraggingViaTouch = false;
                  }
            } else {
                 // å¤šäºä¸¤æŒ‡ï¼Œé‡ç½®
                 touchIdentifier = null;
                 scrollLastY = null;
                 isMoving = false;
                  if(isDraggingViaTouch) {
                     sendCommand({ type: 'mouse_up', button: 'left' });
                     isDraggingViaTouch = false;
                  }
            }
        }, { passive: false }); // passive: false å…è®¸ preventDefault

        touchpad.addEventListener('touchmove', (e) => {
            e.preventDefault();
             if (!isConnected) return;

            // å•æŒ‡ç§»åŠ¨ æˆ– æ‹–æ‹½
            if (e.touches.length === 1 && touchIdentifier !== null) {
                 const touch = Array.from(e.touches).find(t => t.identifier === touchIdentifier);
                 if(!touch) return;

                 const dx = Math.round(touch.clientX - lastX);
                 const dy = Math.round(touch.clientY - lastY);

                 // åˆ¤æ–­æ˜¯å¦è¶…è¿‡ç§»åŠ¨é˜ˆå€¼
                 if (!isMoving && (Math.abs(touch.clientX - startX) > MOVE_THRESHOLD || Math.abs(touch.clientY - startY) > MOVE_THRESHOLD)) {
                    isMoving = true;
                 }

                 if ( (isMoving || isDraggingViaTouch) && (dx !== 0 || dy !== 0) ) {
                     // åº”ç”¨é€Ÿåº¦ç³»æ•°
                     const scaledDx = Math.round(dx * mouseSensitivity);
                     const scaledDy = Math.round(dy * mouseSensitivity);
                     // åªæœ‰å½“ç¼©æ”¾åçš„å€¼ä¸ä¸º0æ—¶æ‰å‘é€
                     if (scaledDx !== 0 || scaledDy !== 0) {
                         sendCommand({ type: 'move', dx: scaledDx, dy: scaledDy });
                     }
                 }
                 lastX = touch.clientX;
                 lastY = touch.clientY;
            }
            // åŒæŒ‡æ»šåŠ¨
            else if (e.touches.length === 2 && scrollLastY !== null) {
                 const currentAvgY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                 const deltaY = currentAvgY - scrollLastY;
                 // pyautogui.scroll: æ­£æ•°å‘ä¸Šï¼Œè´Ÿæ•°å‘ä¸‹ã€‚æ‰‹æŒ‡å‘ä¸‹æ»‘åŠ¨(deltaY > 0)ï¼Œå†…å®¹åº”å‘ä¸Šæ»š(amount < 0)
                 const amount = Math.round(-deltaY * SCROLL_SENSITIVITY);
                 if (Math.abs(amount) > 0) {
                    sendCommand({ type: 'scroll', amount: amount });
                 }
                 scrollLastY = currentAvgY;
                 isMoving = false; // æ»šåŠ¨æ—¶ä¸ç®—ç§»åŠ¨
            }
        }, { passive: false });

        const handleTouchEnd = (e) => {
             e.preventDefault();
             if (!isConnected) return;

             // ç¡®ä¿æ˜¯æœ€åä¸€ä¸ªæ‰‹æŒ‡ç¦»å¼€ ä¸” ä¸æ˜¯åœ¨æ»šåŠ¨
             if (e.touches.length === 0 && scrollLastY === null) {

                 // å¦‚æœä¹‹å‰è§¦å‘äº†æ‹–æ‹½ï¼Œåˆ™æŠ¬èµ·é¼ æ ‡
                 if(isDraggingViaTouch) {
                     sendCommand({ type: 'mouse_up', button: 'left' });
                     isDraggingViaTouch = false;
                 }
                 // å¦‚æœæ²¡æœ‰ç§»åŠ¨è¿‡ï¼ˆæˆ–ç§»åŠ¨å¾ˆå°ï¼‰ï¼Œåˆ¤å®šä¸º Tap-to-Click
                 else if (!isMoving && !dragLockActive) {
                     const now = Date.now();
                     if (now - lastTapTime < DOUBLE_TAP_THRESHOLD) {
                         sendCommand({ type: 'double_click' });
                         lastTapTime = 0; // é˜²æ­¢ä¸‰è¿å‡»
                     } else {
                        sendCommand({ type: 'click' }); // å•å‡»
                        lastTapTime = now;
                     }
                 }
             }
            // é‡ç½®çŠ¶æ€
            if (e.touches.length === 0) {
               lastX = undefined;
               lastY = undefined;
               startX = undefined;
               startY = undefined;
               scrollLastY = null;
               touchIdentifier = null;
               isMoving = false;
               // isDraggingViaTouch = false; // å·²åœ¨ä¸Šé¢å¤„ç†
            }
        };

        touchpad.addEventListener('touchend', handleTouchEnd, { passive: false });
        touchpad.addEventListener('touchcancel', handleTouchEnd, { passive: false }); // æ„å¤–ä¸­æ–­æ—¶ä¹Ÿè¦å¤„ç†

        // --- æŒ‰é’®ç›‘å¬ ---
        // æ¨¡æ‹ŸæŒ‰ä¸‹å’ŒæŠ¬èµ·æ•ˆæœ (æ—§å‡½æ•°ï¼Œä¸å†éœ€è¦)
         // const buttonPress = (btn, command) => { ... };
         // const buttonRelease = (btn) => { ... };

        leftClickBtn.addEventListener('pointerdown', () => sendCommand({ type: 'click' })); // ç®€åŒ–ï¼šç›´æ¥å‘é€å‘½ä»¤
        // leftClickBtn.addEventListener('pointerup', () => buttonRelease(leftClickBtn)); // ä¸å†éœ€è¦å•ç‹¬çš„ release
        // leftClickBtn.addEventListener('pointerout', () => buttonRelease(leftClickBtn));

        rightClickBtn.addEventListener('pointerdown', () => sendCommand({ type: 'right_click' }));
        // rightClickBtn.addEventListener('pointerup', () => buttonRelease(rightClickBtn));
        // rightClickBtn.addEventListener('pointerout', () => buttonRelease(rightClickBtn));

        // æ‹–æ‹½é”å®šæŒ‰é’®
         dragLockBtn.addEventListener('click', () => {
            dragLockActive = !dragLockActive;
            dragLockBtn.classList.toggle('active', dragLockActive);
            // å¦‚æœåœ¨è§¦æ‘¸è¿‡ç¨‹ä¸­å…³é—­é”å®šï¼Œç¡®ä¿é¼ æ ‡æŠ¬èµ·
            if(!dragLockActive && isDraggingViaTouch){
                 sendCommand({ type: 'mouse_up', button: 'left' });
                 isDraggingViaTouch = false;
            }
             console.log("Drag Lock:", dragLockActive);
         });

         // é”®ç›˜è¾“å…¥
         sendTextBtn.addEventListener('click', () => {
             if(keyboardInput.value) {
                sendCommand({type: 'typewrite', text: keyboardInput.value});
                keyboardInput.value = ''; // å‘é€åæ¸…ç©º
             }
              keyboardInput.blur(); // æ”¶èµ·é”®ç›˜
         });
         // è¾“å…¥æ¡†å›è½¦å‘é€
         keyboardInput.addEventListener('keydown', (e) => {
            if(e.key === 'Enter'){
                 e.preventDefault();
                 sendTextBtn.click();
            }
         });

         // ç‰¹æ®ŠæŒ‰é”® - [æ—§é€»è¾‘å·²ç§»é™¤ï¼Œå°†è¢«ä¸‹æ–¹ç»Ÿä¸€é€»è¾‘æ›¿ä»£]

         // --- æ–°å¢æŒ‰é’®ç›‘å¬ ---
         // åˆ‡æ¢é”®ç›˜æ˜¾ç¤º/éšè— (Modified logic)
         toggleKeyboardBtn.addEventListener('click', () => {
             // Logic: Toggle the 'visible' class. If it becomes visible, fine. If it becomes hidden, fine.
             // The .toggle() method handles both adding and removing based on current state.
             fullKeyboard.classList.toggle('visible');
             // No need for explicit check, .toggle() does what's needed.
         });

         // æ–°é”®ç›˜åŒºåŸŸæŒ‰é”®ç›‘å¬ - [æ—§é€»è¾‘å·²ç§»é™¤ï¼Œå°†è¢«ä¸‹æ–¹ç»Ÿä¸€é€»è¾‘æ›¿ä»£]

         // æ–°å¢ï¼šé”®ç›˜å†…éƒ¨çš„éšè—æŒ‰é’® - [æ—§é€»è¾‘å·²ç§»é™¤ï¼Œå°†è¢«ä¸‹æ–¹ç»Ÿä¸€é€»è¾‘æ›¿ä»£]


         // --- æ–°å¢ï¼šç»Ÿä¸€å¤„ç†æ‰€æœ‰é”®ç›˜æŒ‰é”®ï¼ˆåŒ…æ‹¬ä¿®é¥°é”®ï¼‰ ---
         const allKeyButtons = document.querySelectorAll('.btn-key[data-key], .keyboard-button[data-key]');

         allKeyButtons.forEach(btn => {
             const key = btn.dataset.key;

             btn.addEventListener('pointerdown', () => {
                 if (!isConnected) return; // æœªè¿æ¥æ—¶ä¸å¤„ç†

                 if (key === 'ctrl' || key === 'alt' || key === 'shift') {
                     // åˆ‡æ¢ä¿®é¥°é”®çŠ¶æ€
                     if (key === 'ctrl') isCtrlActive = !isCtrlActive;
                     else if (key === 'alt') isAltActive = !isAltActive;
                     else if (key === 'shift') isShiftActive = !isShiftActive;
                     // åˆ‡æ¢è§†è§‰çŠ¶æ€
                     btn.classList.toggle('active', key === 'ctrl' ? isCtrlActive : (key === 'alt' ? isAltActive : isShiftActive));
                     // console.log(`Modifier ${key} active:`, key === 'ctrl' ? isCtrlActive : (key === 'alt' ? isAltActive : isShiftActive)); // Debug
                 } else if (key === 'capslock') {
                     // å¤„ç† Caps Lock åˆ‡æ¢
                     isCapsLockActive = !isCapsLockActive;
                     btn.classList.toggle('active', isCapsLockActive);
                     updateKeyboardCase();
                     // å‘é€ Caps Lock æŒ‰é”®æŒ‡ä»¤ï¼ˆé€šå¸¸ä¸éœ€è¦ä¿®é¥°é”®ï¼‰
                     sendCommand({ type: 'key_press', value: key, modifiers: [] });
                 } else if (key === 'hide') {
                     // å¤„ç†éšè—æŒ‰é’® (ä»…éšè—é”®ç›˜ï¼Œä¸å‘é€æŒ‡ä»¤)
                     fullKeyboard.classList.remove('visible');
                     btn.classList.add('active'); // æ¨¡æ‹Ÿç¬é—´æŒ‰ä¸‹æ•ˆæœ
                 } else {
                     // å¤„ç†æ™®é€šæŒ‰é”®ï¼ˆåŒ…æ‹¬ Win, Enter, Esc, F1-F12, Arrows, etc.ï¼‰
                     const activeModifiers = [];
                     if (isCtrlActive) activeModifiers.push('ctrl');
                     if (isAltActive) activeModifiers.push('alt');
                     if (isShiftActive) activeModifiers.push('shift');

                     sendCommand({ type: 'key_press', value: key, modifiers: activeModifiers });
                     // æ¨¡æ‹Ÿç¬é—´æŒ‰ä¸‹æ•ˆæœ
                     btn.classList.add('active');
                 }
             });

             btn.addEventListener('pointerup', () => {
                 // åªä¸ºéç²˜æ»é”®ç§»é™¤ active çŠ¶æ€
                 if (key !== 'ctrl' && key !== 'alt' && key !== 'shift' && key !== 'capslock') {
                     btn.classList.remove('active');
                 }
             });

             btn.addEventListener('pointerout', () => {
                 // å¦‚æœæŒ‡é’ˆç§»å‡ºï¼Œä¹Ÿä¸ºéç²˜æ»é”®ç§»é™¤ active çŠ¶æ€
                 if (key !== 'ctrl' && key !== 'alt' && key !== 'shift' && key !== 'capslock') {
                     btn.classList.remove('active');
                 }
             });
         });
         // --- ç»Ÿä¸€å¤„ç†ç»“æŸ ---


         // æ–°å¢ï¼šåˆ‡æ¢å¸ƒå±€æŒ‰é’®
         if (toggleLayoutBtn) {
             toggleLayoutBtn.addEventListener('click', () => {
                 document.body.classList.toggle('layout-landscape');
                 // Optional: Add active state simulation if needed
             });
         }

         // å…³æœºæŒ‰é’®
         shutdownBtn.addEventListener('click', () => {
             if (confirm('ç¡®å®šè¦å…³é—­ç”µè„‘å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
                 console.log("å‘é€å…³æœºæŒ‡ä»¤...");
                 sendCommand({ type: 'shutdown' });
                 // å¯ä»¥åœ¨æ­¤æ·»åŠ ä¸€äº›è§†è§‰åé¦ˆï¼Œæ¯”å¦‚æŒ‰é’®å˜ç°æˆ–æ˜¾ç¤ºæ¶ˆæ¯
                 setStatus('æ­£åœ¨å‘é€å…³æœºæŒ‡ä»¤...', 'connecting');
             } else {
                 console.log("å–æ¶ˆå…³æœºæ“ä½œã€‚");
             }
         });

         // Removed: åˆ‡æ¢é¼ æ ‡è½¨è¿¹æŒ‰é’® logic


        // --- å¯åŠ¨è¿æ¥ ---
        connect();

        // --- æ–°å¢ï¼šæ›´æ–°é”®ç›˜å¤§å°å†™æ˜¾ç¤º ---
        function updateKeyboardCase() {
            // é€‰æ‹©æ‰€æœ‰è¡¨ç¤ºå•ä¸ªå­—æ¯çš„æŒ‰é’® (ç®€å•æ–¹æ³•ï¼šæ£€æŸ¥ data-key æ˜¯å¦ä¸ºå•ä¸ªå°å†™å­—æ¯)
            const letterButtons = fullKeyboard.querySelectorAll('.keyboard-button');
            letterButtons.forEach(btn => {
                const key = btn.dataset.key;
                // ä»…å¤„ç†å•ä¸ªå­—æ¯æŒ‰é”®
                if (key && key.length === 1 && key >= 'a' && key <= 'z') {
                    btn.textContent = isCapsLockActive ? key.toUpperCase() : key.toLowerCase();
                }
            });
        }

        // åˆå§‹åŒ–é”®ç›˜å¤§å°å†™çŠ¶æ€
        updateKeyboardCase();

        // Initialize sensitivity display and values on load using the value from localStorage or default
        updateSensitivity(mouseSensitivity);

    </script>
</body>
</html>
